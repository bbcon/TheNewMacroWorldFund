<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Portfolio + TAA Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      font-family: "Inter", "Segoe UI", system-ui, sans-serif;
      color: #0f172a;
      background: #f8fafc;
      line-height: 1.5;
    }
    body {
      margin: 0;
      padding: 24px;
      max-width: 1180px;
      margin-inline: auto;
    }
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .tab-btn {
      border: 1px solid #e2e8f0;
      background: #fff;
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      color: #0f172a;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.05);
    }
    .tab-btn.active {
      background: #0f766e;
      color: #ecfeff;
      border-color: #0f766e;
    }
    .contact-wrap {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 16px;
      align-items: start;
    }
    .contact-photo {
      width: 140px;
      height: 140px;
      border-radius: 999px;
      object-fit: cover;
      object-position: center 20%;
      border: 2px solid #e2e8f0;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
    }
    .contact-photo-wrap {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    header {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      align-items: baseline;
      margin-bottom: 16px;
    }
    h1 { margin: 0; font-size: 28px; letter-spacing: -0.3px; }
    .muted { color: #475569; }
    .pill {
      padding: 6px 12px;
      background: #0f766e;
      color: #ecfeff;
      border-radius: 999px;
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .card {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 4px 16px rgba(15, 23, 42, 0.05);
      margin-bottom: 16px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
    }
    .stat {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .stat .label { color: #475569; font-size: 13px; }
    .stat .value { font-size: 22px; font-weight: 700; }
    .flex {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 16px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #e2e8f0;
      text-align: left;
    }
    th { background: #f1f5f9; }
    tr:hover { background: #f8fafc; }
    .empty {
      text-align: center;
      color: #94a3b8;
      padding: 12px 0;
      font-size: 14px;
    }
    details {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 10px 12px;
      background: #f8fafc;
      margin-bottom: 8px;
    }
    details p { margin: 6px 0; }
    details ul { margin: 6px 0 0 18px; padding-left: 16px; list-style: disc; }
    summary {
      cursor: pointer;
      font-weight: 600;
      color: #0f172a;
      outline: none;
    }
    .muted-small { color: #64748b; font-size: 13px; margin: 4px 0 0 0; }
    a { color: #0f766e; text-decoration: none; }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Portfolio + TAA Dashboard</h1>
      <div class="muted">NAV, risk, attribution, and trade-level detail (data from R exports under <code>docs/data</code>).</div>
    </div>
    <span class="pill">Live Data</span>
  </header>
  <div class="tabs">
    <button class="tab-btn active" data-tab="dashboard">Dashboard</button>
    <button class="tab-btn" data-tab="about">About the Fund</button>
    <button class="tab-btn" data-tab="contact">Contact</button>
  </div>

  <div id="dashboard-tab">
    <div class="card grid" id="metric-cards"></div>

    <div class="flex">
      <div class="card">
        <h3 style="margin:0 0 8px 0;">NAV</h3>
        <canvas id="nav-chart" height="220"></canvas>
      </div>
      <div class="card">
        <h3 style="margin:0 0 8px 0;">Drawdowns</h3>
        <canvas id="dd-chart" height="220"></canvas>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px 0;">Rolling Metrics (63d)</h3>
      <canvas id="rolling-chart" height="200"></canvas>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px 0;">Attribution (SAA vs TAA)</h3>
      <canvas id="attrib-chart" height="220"></canvas>
    </div>

    <div class="flex">
      <div class="card">
        <h3 style="margin:0 0 8px 0;">Trade Equity Curve</h3>
        <canvas id="trade-equity-chart" height="200"></canvas>
      </div>
      <div class="card">
        <h3 style="margin:0 0 8px 0;">Trades</h3>
        <table id="trades-table">
          <thead>
            <tr>
              <th>Trade</th>
              <th>Entry</th>
              <th>Exit</th>
              <th>Return</th>
              <th>DD</th>
              <th>Sharpe</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card" id="trade-rationales-card">
      <h3 style="margin:0 0 8px 0;">Trade Rationales</h3>
      <div id="trade-rationales"></div>
    </div>
  </div>

  <div id="about-tab" style="display:none;">
    <div class="card">
      <h3 style="margin:0 0 8px 0;">About the Fund</h3>
      <div id="about-content" class="muted-small"></div>
    </div>
  </div>

  <div id="contact-tab" style="display:none;">
    <div class="card">
      <h3 style="margin:0 0 8px 0;">Contact</h3>
      <div class="contact-wrap">
        <div class="contact-photo-wrap">
          <img src="./CV_BB_pic.jpg" alt="Brendan Berthold" class="contact-photo" />
        </div>
        <div id="contact-content" class="muted-small"></div>
      </div>
    </div>
  </div>

  <script>
    const fmtPct = (n, digits = 1) => n === null || n === undefined || isNaN(n) ? "—" : `${(n * 100).toFixed(digits)}%`;
    const fmtNum = (n, digits = 2) => n === null || n === undefined || isNaN(n) ? "—" : n.toFixed(digits);
    const fetchJSON = async (path) => {
      try {
        const res = await fetch(path);
        if (!res.ok) return [];
        return await res.json();
      } catch (e) {
        console.warn("Failed to load", path, e);
        return [];
      }
    };

    function groupBy(arr, keyFn) {
      return arr.reduce((acc, item) => {
        const k = keyFn(item);
        acc[k] = acc[k] || [];
        acc[k].push(item);
        return acc;
      }, {});
    }

    const escapeHtml = (str) => {
      if (str === null || str === undefined) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#39;");
    };

    function formatNarrative(text) {
      if (!text) return "<span class=\"muted-small\">No rationale provided.</span>";
      const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      if (!lines.length) return "<span class=\"muted-small\">No rationale provided.</span>";
      let html = [];
      let bullets = [];
      const flushBullets = () => {
        if (bullets.length) {
          html.push(`<ul>${bullets.map(item => `<li>${escapeHtml(item)}</li>`).join("")}</ul>`);
          bullets = [];
        }
      };
      lines.forEach(line => {
        const bulletMatch = line.match(/^[-*]\s+(.*)/);
        if (bulletMatch) {
          bullets.push(bulletMatch[1]);
        } else {
          flushBullets();
          html.push(`<p>${escapeHtml(line)}</p>`);
        }
      });
      flushBullets();
      return html.join("");
    }

    function renderMarkdown(md) {
      if (!md) return "";
      const lines = md.split(/\r?\n/);
      const out = [];
      let inList = false;
      const closeList = () => { if (inList) { out.push("</ul>"); inList = false; } };
      lines.forEach(line => {
        const trimmed = line.trim();
        if (!trimmed) { closeList(); return; }
        const listMatch = trimmed.match(/^[-*]\s+(.*)/);
        const h1 = trimmed.match(/^#\s+(.*)/);
        const h2 = trimmed.match(/^##\s+(.*)/);
        const h3 = trimmed.match(/^###\s+(.*)/);
        if (h1) { closeList(); out.push(`<h2>${escapeHtml(h1[1])}</h2>`); return; }
        if (h2) { closeList(); out.push(`<h3>${escapeHtml(h2[1])}</h3>`); return; }
        if (h3) { closeList(); out.push(`<h4>${escapeHtml(h3[1])}</h4>`); return; }
        if (listMatch) {
          if (!inList) { out.push("<ul>"); inList = true; }
          out.push(`<li>${escapeHtml(listMatch[1])}</li>`);
          return;
        }
        closeList();
        const bolded = escapeHtml(trimmed).replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
        out.push(`<p>${bolded}</p>`);
      });
      closeList();
      return out.join("");
    }

    function renderMetricCards(metrics) {
      if (!metrics.length) {
        document.getElementById("metric-cards").innerHTML = '<div class="empty">No metrics found. Run the R exporters.</div>';
        return;
      }
      const periods = ["since_inception", `${new Date().getFullYear()}_ytd`];
      const strategies = Array.from(new Set(metrics.map(m => m.strategy)));
      const rows = [];
      strategies.forEach(strategy => {
        periods.forEach(period => {
          const row = metrics.find(m => m.strategy === strategy && m.period === period);
          if (row) rows.push(row);
        });
      });
      document.getElementById("metric-cards").innerHTML = rows.map(r => `
        <div class="card stat">
          <div class="label">${r.strategy} · ${r.period.replace("_", " ").toUpperCase()}</div>
          <div class="value">${fmtPct(r.total_return, 2)}</div>
          <div class="muted">CAGR ${fmtPct(r.cagr, 2)} · Vol ${fmtPct(r.vol, 2)} · Sharpe ${fmtNum(r.sharpe, 2)} · MaxDD ${fmtPct(r.max_drawdown, 1)}</div>
        </div>
      `).join("");
    }

    function renderNavChart(ctx, portfolio) {
      if (!portfolio.length) return;
      const grouped = groupBy(portfolio, d => d.strategy);
      const labels = Array.from(new Set(portfolio.map(d => d.date))).sort();
      const colors = ["#0f766e", "#2563eb", "#d97706", "#8b5cf6"];
      const datasets = Object.entries(grouped).map(([strategy, rows], i) => ({
        label: strategy,
        data: labels.map(d => {
          const row = rows.find(r => r.date === d);
          return row ? row.nav : null;
        }),
        borderColor: colors[i % colors.length],
        tension: 0.2,
        spanGaps: true
      }));
      new Chart(ctx, {
        type: "line",
        data: { labels, datasets },
        options: { plugins: { legend: { display: true } }, scales: { y: { beginAtZero: false } } }
      });
    }

    function renderDrawdownChart(ctx, drawdowns) {
      if (!drawdowns.length) return;
      const grouped = groupBy(drawdowns, d => d.strategy);
      const labels = Array.from(new Set(drawdowns.map(d => d.date))).sort();
      const colors = ["#dc2626", "#0ea5e9", "#7c3aed"];
      const datasets = Object.entries(grouped).map(([strategy, rows], i) => ({
        label: strategy,
        data: labels.map(d => {
          const row = rows.find(r => r.date === d);
          return row ? row.drawdown : null;
        }),
        borderColor: colors[i % colors.length],
        backgroundColor: "transparent",
        tension: 0.2,
        spanGaps: true
      }));
      new Chart(ctx, {
        type: "line",
        data: { labels, datasets },
        options: {
          scales: {
            y: {
              ticks: { callback: v => fmtPct(v, 0) },
              min: Math.min(-0.6, Math.min(...drawdowns.map(d => d.drawdown || 0)))
            }
          }
        }
      });
    }

    function renderRollingChart(ctx, rolling) {
      if (!rolling.length) return;
      const grouped = groupBy(rolling, d => d.strategy);
      const labels = Array.from(new Set(rolling.map(d => d.date))).sort();
      const colors = ["#0f766e", "#2563eb", "#d97706", "#8b5cf6"];
      const datasets = Object.entries(grouped).map(([strategy, rows], i) => ({
        label: `${strategy} · roll Sharpe (63d)`,
        data: labels.map(d => {
          const row = rows.find(r => r.date === d);
          return row ? row.roll_63_sharpe : null;
        }),
        borderColor: colors[i % colors.length],
        tension: 0.2,
        spanGaps: true
      }));
      new Chart(ctx, {
        type: "line",
        data: { labels, datasets },
        options: { scales: { y: { beginAtZero: false } } }
      });
    }

    function renderAttribChart(ctx, attrib) {
      if (!attrib.length) return;
      const monthly = attrib.map(r => ({
        month: r.date.slice(0, 7),
        strategy: r.strategy,
        return_saa: r.return_saa,
        return_taa: r.return_taa
      }));
      const grouped = groupBy(monthly, r => `${r.strategy}-${r.month}`);
      const rows = Object.entries(grouped).map(([key, vals]) => {
        const [strategy, month] = key.split("-");
        return {
          strategy,
          month,
          return_saa: vals.reduce((a, b) => a + (b.return_saa || 0), 0),
          return_taa: vals.reduce((a, b) => a + (b.return_taa || 0), 0)
        };
      });
      const labels = Array.from(new Set(rows.map(r => r.month))).sort();
      const strategies = Array.from(new Set(rows.map(r => r.strategy)));
      const datasets = [];
      strategies.forEach(strategy => {
        datasets.push({
          label: `${strategy} · SAA`,
          stack: strategy,
          backgroundColor: "rgba(15,118,110,0.6)",
          data: labels.map(m => {
            const row = rows.find(r => r.strategy === strategy && r.month === m);
            return row ? row.return_saa : 0;
          })
        });
        datasets.push({
          label: `${strategy} · TAA`,
          stack: strategy,
          backgroundColor: "rgba(217,95,2,0.6)",
          data: labels.map(m => {
            const row = rows.find(r => r.strategy === strategy && r.month === m);
            return row ? row.return_taa : 0;
          })
        });
      });
      new Chart(ctx, {
        type: "bar",
        data: { labels, datasets },
        options: {
          responsive: true,
          plugins: { legend: { position: "top" } },
          scales: { y: { ticks: { callback: v => fmtPct(v, 0) } }, x: { stacked: true }, yAxes: [{ stacked: true }] }
        }
      });
    }

    function renderTradeEquity(ctx, tradeEquity) {
      if (!tradeEquity.length) return;
      const labels = tradeEquity.map(r => r.date);
      new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "Trade NAV",
            data: tradeEquity.map(r => r.nav),
            borderColor: "#0ea5e9",
            tension: 0.2,
            spanGaps: true
          }]
        },
        options: { scales: { y: { beginAtZero: false } } }
      });
    }

    function renderTradesTable(trades) {
      const body = document.querySelector("#trades-table tbody");
      if (!trades.length) {
        body.innerHTML = `<tr><td class="empty" colspan="6">No trades found.</td></tr>`;
        return;
      }
      body.innerHTML = trades.sort((a, b) => (b.exit_date || "").localeCompare(a.exit_date || "")).map(t => `
        <tr>
          <td>${t.trade_id}</td>
          <td>${t.entry_date}</td>
          <td>${t.exit_date || "Open"}</td>
          <td>${fmtPct(t.spread_total_return ?? t.total_return, 2)}</td>
          <td>${fmtPct(t.max_drawdown, 1)}</td>
          <td>${fmtNum(t.sharpe, 2)}</td>
        </tr>
      `).join("");
    }

    function renderTradeRationales(narratives) {
      const container = document.getElementById("trade-rationales");
      if (!narratives.length) {
        container.innerHTML = `<div class="empty">No trade narratives found.</div>`;
        return;
      }
      const rows = narratives.sort((a, b) => {
        const aOpen = !a.exit_date || a.exit_date.toLowerCase() === "open";
        const bOpen = !b.exit_date || b.exit_date.toLowerCase() === "open";
        if (aOpen && !bOpen) return -1;
        if (!aOpen && bOpen) return 1;
        const aDate = a.exit_date ? new Date(a.exit_date).getTime() : 0;
        const bDate = b.exit_date ? new Date(b.exit_date).getTime() : 0;
        return bDate - aDate;
      });
      container.innerHTML = rows.map(r => {
        const rationaleHtml = formatNarrative(r.rationale);
        const exitHtml = formatNarrative(r.exit_decision);
        return `
          <details>
            <summary>${escapeHtml(r.trade_id || "Trade")} · ${escapeHtml(r.title || "Trade rationale")}</summary>
            <div class="muted-small"><strong>Entry:</strong> ${escapeHtml(r.entry_date || "—")} · <strong>Exit:</strong> ${escapeHtml(r.exit_date || "Open")}</div>
            <div class="muted-small" style="margin-top:6px;"><strong>Rationale:</strong> ${rationaleHtml}</div>
            <div class="muted-small" style="margin-top:6px;"><strong>Exit decision:</strong> ${exitHtml}</div>
          </details>
        `;
      }).join("");
    }

    function wireTabs() {
      const buttons = document.querySelectorAll(".tab-btn");
      const dashboard = document.getElementById("dashboard-tab");
      const about = document.getElementById("about-tab");
      const contact = document.getElementById("contact-tab");
      buttons.forEach(btn => {
        btn.addEventListener("click", () => {
          buttons.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          const tab = btn.dataset.tab;
          dashboard.style.display = tab === "dashboard" ? "block" : "none";
          about.style.display = tab === "about" ? "block" : "none";
          contact.style.display = tab === "contact" ? "block" : "none";
        });
      });
    }

    async function init() {
      wireTabs();
      const [
        portfolio,
        metrics,
        drawdowns,
        rolling,
        attribution,
        tradesSummary,
        tradesEquity,
        tradesNarratives
      ] = await Promise.all([
        fetchJSON("./data/portfolio.json"),
        fetchJSON("./data/metrics.json"),
        fetchJSON("./data/drawdowns.json"),
        fetchJSON("./data/rolling.json"),
        fetchJSON("./data/attribution.json"),
        fetchJSON("./data/trades_summary.json"),
        fetchJSON("./data/trades_equity.json"),
        fetchJSON("./data/trades_narratives.json")
      ]);

      renderMetricCards(metrics);
      renderNavChart(document.getElementById("nav-chart"), portfolio);
      renderDrawdownChart(document.getElementById("dd-chart"), drawdowns);
      renderRollingChart(document.getElementById("rolling-chart"), rolling);
      renderAttribChart(document.getElementById("attrib-chart"), attribution);
      renderTradeEquity(document.getElementById("trade-equity-chart"), tradesEquity);
      renderTradesTable(tradesSummary);
      renderTradeRationales(tradesNarratives);
      loadAbout();
      loadContact();
    }

    async function loadAbout() {
      try {
        const res = await fetch("./about.md");
        if (!res.ok) throw new Error("missing about.md");
        const md = await res.text();
        document.getElementById("about-content").innerHTML = renderMarkdown(md);
      } catch (e) {
        document.getElementById("about-content").innerHTML = '<div class="empty">About content not available.</div>';
      }
    }

    async function loadContact() {
      try {
        const res = await fetch("./contact.md");
        if (!res.ok) throw new Error("missing contact.md");
        const md = await res.text();
        document.getElementById("contact-content").innerHTML = renderMarkdown(md);
      } catch (e) {
        document.getElementById("contact-content").innerHTML = '<div class="empty">Contact content not available.</div>';
      }
    }

    init();
  </script>
</body>
</html>
